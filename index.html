<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Roue Soleil/Lune — Cadeau</title>
<style>
  :root{
    --ink:#eef1f7; --muted:#b9c2d6; --stroke:rgba(255,255,255,.22);
    --haloSun1:#FFD07A; --haloSun2:#FF9F6C;
    --haloMoon1:#9CC8FF; --haloMoon2:#A38CFF;
    --violet:#6f4aff;
    --glassA:rgba(255,255,255,.18); --glassB:rgba(255,255,255,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%; overscroll-behavior:none}
  body{
    margin:0; color:var(--ink);
    font:16px/1.4 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,system-ui,Arial;
    background:#0b0f1a;
  }
  body.modal-open{position:fixed; left:0; right:0; width:100%}

  /* Fonds */
  #bg{position:fixed; inset:0; z-index:-3; background:#0b0f1a center/cover no-repeat}
  #bg.sun{background-image:url(assets/bg_sun.png)}
  #bg.moon{background-image:url(assets/bg_moon.png)}

  /* Particules ambiance */
  .particles{position:fixed; inset:0; z-index:-1; pointer-events:none}

  /* Barre Soleil/Lune */
  .tabs{position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:10; display:flex; gap:8px}
  .tab{padding:9px 16px; border-radius:999px; backdrop-filter: blur(12px);
       background:linear-gradient(145deg,var(--glassA),var(--glassB));
       border:1px solid var(--stroke); font-weight:800; color:#101425; cursor:pointer; user-select:none}
  .tab.off{color:#e6ebff; opacity:.65}

  /* Roue */
  .wheel-wrap{
    position:relative; width:min(92vw,560px); aspect-ratio:1/1; margin:70px auto 0;
    border-radius:50%; overflow:visible; z-index:2;
  }
  .wheel-clip{position:absolute; inset:0; border-radius:50%; overflow:hidden; pointer-events:none}
  .wheel-border{
    position:absolute; inset:-2%; border-radius:50%; pointer-events:none;
    box-shadow: inset 0 0 0 8px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.15);
  }
  .halo{
    position:absolute; inset:-5%; border-radius:50%; z-index:3; pointer-events:none;
    filter:blur(14px) saturate(120%); opacity:.62; mix-blend-mode:screen;
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 56%, #000 58%, #000);
            mask: radial-gradient(circle at 50% 50%, transparent 56%, #000 58%, #000);
    animation:spinHalo 18s linear infinite;
  }
  .halo.sun{background:conic-gradient(from 0deg, var(--haloSun1), var(--haloSun2), var(--haloSun1))}
  .halo.moon{background:conic-gradient(from 0deg, var(--haloMoon1), var(--haloMoon2), var(--haloMoon1))}
  @keyframes spinHalo{to{transform:rotate(360deg)}}

  /* Rotor = ce qui tourne (segments) */
  .rotor{position:absolute; inset:0; transform:rotate(0deg); will-change:transform}
  #segCanvas{position:absolute; inset:0; display:block; z-index:3; pointer-events:none}  /* au-dessus des PNG */
  .skin{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; border-radius:50%;
        pointer-events:none; z-index:1; opacity:.85; mix-blend-mode:multiply} /* PNG visible sans masquer */

  .pointer{
    position:absolute; top:-6px; left:50%; transform:translateX(-50%); z-index:5;
    width:24px; height:38px;
    background: radial-gradient(circle at 50% 60%, #8c76ff, var(--violet) 60%, #5130df 100%);
    -webkit-clip-path: path("M12 0 C18 8 18 30 12 38 C6 30 6 8 12 0 Z");
            clip-path: path("M12 0 C18 8 18 30 12 38 C6 30 6 8 12 0 Z");
    filter: drop-shadow(0 8px 10px rgba(0,0,0,.5));
    pointer-events:none;
  }
  #hub{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:26%; aspect-ratio:1/1; border-radius:50%; z-index:6; display:grid; place-items:center; cursor:pointer;
    background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.85), rgba(255,255,255,.55) 55%, rgba(255,255,255,.18) 75%);
    box-shadow: 0 16px 40px rgba(0,0,0,.45), inset 0 2px 8px rgba(255,255,255,.85); border:0;
  }
  #hub:active{scale:.98}
  #hub::after{content:""; width:62%; aspect-ratio:1/1; border-radius:50%;
    background:radial-gradient(circle at 50% 45%, rgba(255,255,255,.95), rgba(255,255,255,.6));
    box-shadow: inset 0 1px 2px rgba(0,0,0,.12);}

  /* Modal */
  .modal{display:none}
  .modal.is-open{display:block}
  .modal__backdrop{position:fixed; inset:0; background:rgba(10,12,20,.45); backdrop-filter: blur(6px); z-index:4000}
  .modal__sheet{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
    width:min(92vw,640px); border-radius:18px; padding:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.25); box-shadow:0 24px 60px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.3);
    display:grid; gap:10px; z-index:4001; opacity:0; transition:.25s; padding-bottom:calc(14px + env(safe-area-inset-bottom))}
  .modal.is-open .modal__sheet{opacity:1; transform:translate(-50%,-50%) scale(1)}
  .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.12); font-weight:700}
  .x{border:none; background:transparent; color:#fff; font-size:20px; cursor:pointer}
  .btns{display:flex; gap:10px}
  .btn{flex:1; padding:12px; border-radius:12px; text-align:center; font-weight:800; color:#0d1122; text-decoration:none; border:0; cursor:pointer;
       box-shadow:0 8px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.7)}
  .go{background:linear-gradient(145deg,#cfe3ff,#9ec7ff)}
  .close{background:linear-gradient(145deg,#ffe1a8,#ffc07a)}

  @media (prefers-reduced-motion:reduce){ .halo{animation:none} .rotor{transition:none!important} }
</style>
</head>
<body>
  <!-- Fonds -->
  <div id="bg" class="sun" aria-hidden="true"></div>
  <!-- Particules -->
  <canvas id="pSun" class="particles" aria-hidden="true"></canvas>
  <canvas id="pMoon" class="particles" aria-hidden="true" style="display:none"></canvas>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Mode">
    <button id="tabSun"  class="tab"     aria-selected="true">Soleil</button>
    <button id="tabMoon" class="tab off" aria-selected="false">Lune</button>
  </div>

  <!-- Roue -->
  <div class="wheel-wrap" id="wheelWrap">
    <div id="halo" class="halo sun" aria-hidden="true"></div>
    <div class="wheel-border" aria-hidden="true"></div>

    <div class="wheel-clip" id="wheelClip">
      <!-- Segments qui TOURNENT -->
      <div id="rotor" class="rotor">
        <canvas id="segCanvas" aria-label="Segments"></canvas>
      </div>
      <!-- Skins PNG FIXES au-dessus (ne tournent pas) -->
      <img id="skinSun"  class="skin" src="assets/wheel_sun.png"  alt="" aria-hidden="true">
      <img id="skinMoon" class="skin" src="assets/wheel_moon.png" alt="" aria-hidden="true" style="display:none">
    </div>

    <div class="pointer" aria-hidden="true"></div>
    <button id="hub" aria-label="Tourner"></button>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal__backdrop"></div>
    <div class="modal__sheet" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="row">
        <div style="font-weight:900; font-size:20px" id="mTitle">Titre</div>
        <div style="display:flex; align-items:center; gap:8px">
          <div id="mBadge" class="pill">Soleil</div>
          <button class="x" id="mClose" aria-label="Fermer">×</button>
        </div>
      </div>
      <div style="color:var(--muted)" id="mMeta">Durée · Ambiance</div>
      <div id="mDesc">Description détaillée.</div>
      <div class="btns">
        <a id="mGo" class="btn go" target="_blank" rel="noopener">Itinéraire</a>
        <button id="mExit" class="btn close">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ================== Données ================== */
const DATA = {
  sun: [
    {title:"Îlots & passerelles du Vieux-Port", meta:"1 h · Nature",     desc:"Mini-îles sauvages, herbes hautes, vue sur Nevers. Parfait en fin d’aprèm.", maps:"Port de la Jonction Nevers"},
    {title:"Sieste musicale — Parc Salengro",   meta:"45 min · Chill",   desc:"Herbe fraîche + livre. Ombre et eau à proximité.", maps:"Parc Roger-Salengro Nevers"},
    {title:"Vitraux contemporains",             meta:"40 min · Culture", desc:"Dans la cathédrale : colorimétrie moderne, faisceaux lumineux au sol.", maps:"Cathédrale de Nevers"},
    {title:"Belvédère du Bec d’Allier",         meta:"1 h 15 · Nature",  desc:"Confluent Loire-Allier. Grand air, oiseaux, horizon magnifique.", maps:"Bec d'Allier panorama"},
    {title:"Vieilles boutiques de faïence",     meta:"40 min · Retro",   desc:"Repérage d’enseignes historiques et vitrines anciennes.", maps:"Rue du 14 Juillet Nevers"},
    {title:"Atelier express — faïence",         meta:"1 h · Créatif",    desc:"Customise une petite pièce dans un atelier du centre.", maps:"Place Carnot Nevers"},
    {title:"Remparts + Tour Goguin (sunset)",   meta:"1 h · Photo",      desc:"Balade douce jusqu’au coucher de soleil sur la Loire.", maps:"Quai des Mariniers Nevers"},
    {title:"Polaroid challenge",                meta:"45 min · Fun",     desc:"3 spots → 3 clichés. Souvenir unique.", maps:"Place Carnot Nevers"}
  ],
  moon: [
    {title:"Fil Bleu — secrets",      meta:"45 min · Urbain",     desc:"Version détails cachés du parcours nocturne en ville.", maps:"Palais ducal de Nevers"},
    {title:"Séance Art & Essai",      meta:"2 h · Ciné",          desc:"Film indé en VO si possible. Salle climatisée.", maps:"Cinéma à Nevers"},
    {title:"Cave/bistrot de poche",   meta:"1 h · Soirée",        desc:"Un verre intimiste dans une micro-adresse locale.", maps:"bar à vin centre Nevers"},
    {title:"Street-art discret",      meta:"45 min · Underground",desc:"Pochoirs, collages et fresques de poche.", maps:"Place Carnot Nevers"},
    {title:"Glyphe mystère",          meta:"30 min · Curiosité",  desc:"Petite chasse à un symbole gravé dans la pierre.", maps:"Centre historique Nevers"},
    {title:"Fresque XXL cachée",      meta:"30 min · Photo",      desc:"Repère une grande fresque discrète en nocturne.", maps:"Centre ancien Nevers"},
    {title:"Observatoire improvisé",  meta:"40 min · Ciel clair",  desc:"Ciel sombre près de la Loire pour lever la tête et rêver.", maps:"Bec d'Allier panorama"}
  ]
};

/* ================== Refs & État ================== */
let mode='sun', items=[...DATA.sun], angle=0, spinning=false, savedScrollY=0;

const $ = s => document.querySelector(s);
const bg   = $('#bg'), tabSun = $('#tabSun'), tabMoon = $('#tabMoon');
const wheelClip = $('#wheelClip'), rotor = $('#rotor'), segCanvas = $('#segCanvas'), sctx = segCanvas.getContext('2d');
const skinSun = $('#skinSun'), skinMoon = $('#skinMoon'), halo = $('#halo'), hub = $('#hub');
const modal = $('#modal'), mTitle=$('#mTitle'), mMeta=$('#mMeta'), mDesc=$('#mDesc'), mGo=$('#mGo'), mBadge=$('#mBadge'), mClose=$('#mClose'), mExit=$('#mExit');
const pSun = $('#pSun'), pMoon = $('#pMoon');

/* ================== Sizing & DPR ================== */
const DPR = () => Math.min(2, window.devicePixelRatio||1);
function sizeSegCanvas(){
  const w = Math.max(1, wheelClip.clientWidth);
  const h = Math.max(1, wheelClip.clientHeight);
  const dpr = DPR();
  segCanvas.width  = Math.round(w*dpr);
  segCanvas.height = Math.round(h*dpr);
  segCanvas.style.width  = w+'px';
  segCanvas.style.height = h+'px';
  sctx.setTransform(dpr,0,0,dpr,0,0);
  drawSegments();
}
addEventListener('resize', sizeSegCanvas);
addEventListener('orientationchange', ()=> setTimeout(sizeSegCanvas,150));

/* ================== Couleurs & libellés ================== */
function palSun(i){ const hues=[35,18,340,310,200,160,90,55]; const h=hues[i%hues.length]; return `hsla(${h},70%,75%,0.78)`;}
function palMoon(i){const hues=[210,230,255,275,295,175,195]; const h=hues[i%hues.length]; return `hsla(${h},55%,72%,0.78)`;}
function colText(hsla){
  const m=hsla.match(/hsla?\((\d+),\s*([\d.]+)%?,\s*([\d.]+)%?/i); if(!m) return '#1b2033';
  const L=parseFloat(m[3]); return (L>60)?'#1b2033':'#f8fbff';
}
function shortLabel(t){
  const clean = t.replace(/[–—,:()]/g,' ').trim();
  const parts = clean.split(/\s+/);
  if(parts[0]?.length>=5) return parts[0];
  if(parts[1]) return (parts[0]+' '+parts[1]).slice(0,12);
  return clean.slice(0,12);
}

/* ================== Dessin segments + libellés ================== */
function roundRect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
function drawSegments(){
  const w = segCanvas.clientWidth, h = segCanvas.clientHeight, r = Math.min(w,h)/2;
  sctx.clearRect(0,0,w,h);
  sctx.save(); sctx.translate(w/2,h/2);
  const n=items.length, seg=(Math.PI*2)/n;

  for(let i=0;i<n;i++){
    const start=i*seg, end=start+seg, mid=start+seg/2;
    const col=(mode==='sun')?palSun(i):palMoon(i);

    // segment
    sctx.beginPath(); sctx.moveTo(0,0); sctx.arc(0,0,r*0.86,start,end); sctx.closePath();
    sctx.fillStyle=col; sctx.fill();

    // séparateur
    sctx.beginPath(); sctx.arc(0,0,r*0.86,end,end);
    sctx.strokeStyle='rgba(255,255,255,.45)'; sctx.lineWidth=Math.max(1,r*0.008); sctx.stroke();

    // pastille label
    const lx=Math.cos(mid)*r*0.58, ly=Math.sin(mid)*r*0.58;
    const label=shortLabel(items[i].title);
    sctx.save(); sctx.translate(lx,ly); sctx.rotate(mid);
    sctx.font='14px Inter, system-ui, -apple-system'; sctx.textAlign='center'; sctx.textBaseline='middle';
    const tw=sctx.measureText(label).width, pw=tw+28, ph=30;
    sctx.shadowColor='rgba(0,0,0,.35)'; sctx.shadowBlur=8; sctx.shadowOffsetY=2;
    sctx.fillStyle='rgba(255,255,255,.94)'; roundRect(sctx,-pw/2,-ph/2,pw,ph,999); sctx.fill();
    sctx.shadowColor='transparent'; sctx.fillStyle=colText(col); sctx.fillText(label,0,1);
    sctx.restore();
  }

  // bord intérieur clair
  sctx.beginPath(); sctx.arc(0,0,r*0.98,0,Math.PI*2);
  sctx.strokeStyle='rgba(255,255,255,.28)'; sctx.lineWidth=Math.max(2,r*0.02); sctx.stroke();

  sctx.restore();
}

/* ================== Particules ================== */
function fitParticles(canvas){
  const dpr=DPR(); canvas.width=Math.round(innerWidth*dpr); canvas.height=Math.round(innerHeight*dpr);
  canvas.style.width='100vw'; canvas.style.height='100vh';
}
function startParticles(){
  fitParticles(pSun); fitParticles(pMoon);
  runParticles(pSun,true); runParticles(pMoon,false);
  addEventListener('resize', ()=>{ fitParticles(pSun); fitParticles(pMoon); });
}
function runParticles(canvas,isSun){
  const ctx = canvas.getContext('2d'); const dpr=DPR(); const P=[];
  for(let i=0;i<120;i++) P.push(spawn(isSun));
  (function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.globalCompositeOperation='lighter';
    for(const p of P){
      p.y+=p.vy; p.x+=Math.sin(p.life*.03)*p.vx; p.life--;
      if(isSun){ const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r); g.addColorStop(0,'rgba(255,210,120,.55)'); g.addColorStop(1,'rgba(255,170,60,0)'); ctx.fillStyle=g; }
      else{ ctx.fillStyle=`rgba(210,230,255,${.35+.25*Math.random()})`; }
      ctx.beginPath(); isSun?ctx.arc(p.x,p.y,p.r,0,Math.PI*2):ctx.rect(p.x,p.y,p.r,p.r); ctx.fill();
      if(p.life<=0 || p.y<-50*dpr || p.y>canvas.height+50*dpr){ Object.assign(p,spawn(isSun)); p.y=isSun?canvas.height+20*dpr:Math.random()*canvas.height; }
    }
    requestAnimationFrame(loop);
  })();
}
function spawn(isSun){
  const dpr=DPR(), W=Math.round(innerWidth*dpr), H=Math.round(innerHeight*dpr);
  return isSun? {x:Math.random()*W,y:H+Math.random()*200*dpr,vx:.6*dpr,vy:-(.6+Math.random()*1.2)*dpr,r:(3+Math.random()*7)*dpr,life:300+Math.random()*200}
               : {x:Math.random()*W,y:Math.random()*H,vx:.5*dpr,vy:(Math.random()*.4-.2)*dpr,r:(1+Math.random()*2)*dpr,life:240+Math.random()*240};
}

/* ================== Spin & Modal ================== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function spinRandom(){
  if(spinning) return; hideModal(); spinning=true;
  const n=items.length, seg=(Math.PI*2)/n;
  const idx=Math.floor(Math.random()*n);
  const target=(Math.PI*1.5)-(idx*seg+seg/2);
  const turns=4+Math.random()*2, startA=angle, endA=target+turns*2*Math.PI;
  const dur=3200+Math.random()*1200, t0=performance.now();
  requestAnimationFrame(function anim(t){
    const p=clamp((t-t0)/dur,0,1), e=1-Math.pow(1-p,3), a=startA+(endA-startA)*e;
    rotor.style.transform=`rotate(${a}rad)`;
    if(p<1) requestAnimationFrame(anim);
    else{
      angle=((target%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
      rotor.style.transform=`rotate(${angle}rad)`; spinning=false; showResult(items[idx]);
      if(navigator.vibrate) navigator.vibrate([10,40,20]);
    }
  });
}
function openModal(){ savedScrollY=scrollY; document.body.classList.add('modal-open'); document.body.style.top=`-${savedScrollY}px`; modal.classList.add('is-open'); modal.setAttribute('aria-hidden','false'); halo.style.opacity=.35; }
function hideModal(){ modal.classList.remove('is-open'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); document.body.style.top=''; halo.style.opacity=''; scrollTo(0,savedScrollY); }
document.querySelector('.modal__backdrop').addEventListener('click', hideModal);
mClose.addEventListener('click', hideModal); mExit.addEventListener('click', hideModal);
function showResult(a){
  mTitle.textContent=a.title; mMeta.textContent=a.meta; mDesc.textContent=a.desc;
  mGo.href=`https://www.google.com/maps?q=${encodeURIComponent(a.maps)}`;
  mBadge.textContent=(mode==='sun'?'Soleil':'Lune'); openModal();
}

/* ================== Changement de mode ================== */
function setMode(m){
  if(mode===m) return; mode=m; items=[...DATA[m]];
  bg.className=m; halo.className='halo '+(m==='sun'?'sun':'moon');
  pSun.style.display=(m==='sun')?'block':'none'; pMoon.style.display=(m==='moon')?'block':'none';
  skinSun.style.display=(m==='sun')?'block':'none'; skinMoon.style.display=(m==='moon')?'block':'none';
  skinSun.style.opacity = (m==='sun')?'.85':'.65'; skinMoon.style.opacity=(m==='moon')?'.85':'.65';
  tabSun.classList.toggle('off',m!=='sun'); tabSun.setAttribute('aria-selected',m==='sun');
  tabMoon.classList.toggle('off',m!=='moon'); tabMoon.setAttribute('aria-selected',m==='moon');
  drawSegments(); rotor.style.transform=`rotate(${angle}rad)`;
}
tabSun.addEventListener('click',()=>setMode('sun'));
tabMoon.addEventListener('click',()=>setMode('moon'));

/* ================== Init ================== */
addEventListener('load', ()=>{
  sizeSegCanvas(); drawSegments(); startParticles();
  hub.addEventListener('click', spinRandom);
  document.getElementById('wheelWrap').addEventListener('gesturestart', e=>e.preventDefault());
});
</script>
</body>
</html>
