<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Roue Soleil/Lune — Nevers (refonte stable)</title>
<style>
:root{
  --ink:#f6f8ff; --muted:#b9c6dd; --stroke:rgba(255,255,255,.16);
  --glass:rgba(255,255,255,.10); --glass2:rgba(255,255,255,.05);
  --bg1:#0a0f1d; --bg2:#0b1429; --violet:#8b7cff; --violetDeep:#6b5bff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2) 55%,var(--bg1));-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* Backdrops PNG 816×1456 (portrait) */
body::before{content:"";position:fixed;inset:0;z-index:-3;opacity:.98;pointer-events:none;background-image:url("assets/bg_sun.png");background-size:cover;background-position:center}
body[data-mode="moon"]::before{background-image:url("assets/bg_moon.png")}

.app{min-height:100dvh;padding:12px 16px 18dvh;display:flex;flex-direction:column;gap:10px}
.header{display:flex;align-items:center;gap:12px;justify-content:center}
.tab{padding:8px 14px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.08);font-weight:800;cursor:pointer;user-select:none}
.tab[aria-pressed="true"]{background:linear-gradient(145deg,#fff6d6,#ffe3a7 45%,#cfe6ff);color:#0b0f1f}

/* STAGE */
.stage{position:relative;width:min(92vw,580px);margin:8px auto 0;aspect-ratio:1/1}
.ringGlow{position:absolute;inset:-12px;border-radius:999px;z-index:0;filter: blur(22px) saturate(130%);opacity:.55}
.pointer{position:absolute;top:-3px;left:50%;translate:-50% 0;z-index:7;width:40px;height:40px;background: radial-gradient(circle at 60% 40%, var(--violet), var(--violetDeep));-webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M22 0 C34 10 34 34 22 44 C10 34 10 10 22 0Z"/></svg>') center/contain no-repeat;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M22 0 C34 10 34 34 22 44 C10 34 10 10 22 0Z"/></svg>') center/contain no-repeat;filter: drop-shadow(0 8px 16px rgba(0,0,0,.6))}

/* ROTATION : on fait tourner TOUT le wrap */
#wheelWrap{position:relative;width:100%;height:100%;transform-origin:50% 50%;will-change:transform;transition: transform 3.2s cubic-bezier(.12,.6,0,1);contain: layout paint size}
/* calques (ordre garanti) */
#wheelSkin{position:absolute;inset:0;width:100%;height:100%;border-radius:50%;object-fit:contain;user-select:none;pointer-events:none;z-index:1;opacity:.9}
#wheelCanvas{position:absolute;inset:0;width:100%;height:100%;border-radius:50%;z-index:2;background:transparent}
/* Hub bouton */
.hub{position:absolute;top:50%;left:50%;translate:-50% -50%;width:20%;aspect-ratio:1/1;border-radius:999px;background: radial-gradient(circle at 50% 40%, #ffffff, #f3f6ff 60%, #e5ecff);box-shadow: 0 10px 20px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.8);display:grid;place-items:center;z-index:6}
.spin{appearance:none;border:none;cursor:pointer;border-radius:999px;width:70%;aspect-ratio:1/1;background: radial-gradient(circle at 50% 45%, #ffffff, #f7f7ff 60%, #e6eaff);box-shadow: inset 0 1px 0 rgba(255,255,255,.8);transition: transform .18s ease}
.spin:active{transform:scale(.97)}

/* MODAL centré (grid), au-dessus de tout */
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:4000}
.modal.show{display:grid}
.backdrop{position:absolute;inset:0;background:rgba(6,10,20,.45);backdrop-filter: blur(8px)}
.sheet{position:relative;width:min(640px,92vw);border-radius:22px;padding:18px 16px;background:radial-gradient(120% 120% at 20% 0%, rgba(255,255,255,.22), rgba(255,255,255,.08) 55%), linear-gradient(160deg,var(--glass),var(--glass2));border:1px solid var(--stroke);box-shadow:0 18px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.2);animation:pop .28s ease forwards;opacity:0;transform:translateY(10px)}
.sheet:before{content:"";position:absolute;left:50%;top:-10px;translate:-50% 0;width:94px;height:12px;border-radius:999px;background:linear-gradient(90deg,#ffe8b8,#b9c9ff)}
@keyframes pop{to{opacity:1;transform:none}}
.sheet h3{margin:0 0 6px;font-size:18px}
.sheet p{margin:0 10px 12px 0;color:var(--muted)}
.sheet .actions{display:flex;gap:8px}
.sheet .btn{flex:1;padding:12px;border-radius:12px;text-align:center;font-weight:900;color:#0b0f1f;text-decoration:none;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.6)}
.sheet .go{background: linear-gradient(145deg,#cfe6ff,#9bc9ff)}
.sheet .close{background: linear-gradient(145deg,#ffe3a7,#ffbd7c)}
.close-x{position:absolute;top:10px;right:10px;border:0;background:transparent;color:#fff;font-size:22px;opacity:.8;cursor:pointer}

@media (prefers-reduced-motion: reduce){ #wheelWrap{transition:none!important} }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header" role="group" aria-label="Choix du set">
    <button id="tabSun" class="tab" aria-pressed="true">Soleil</button>
    <button id="tabMoon" class="tab" aria-pressed="false">Lune</button>
  </div>

  <div class="stage" id="stage">
    <div id="ringGlow" class="ringGlow" aria-hidden="true"></div>
    <div class="pointer" aria-hidden="true"></div>
    <div id="wheelWrap">
      <!-- IMPORTANT : le PNG est SOUS le canvas -->
      <img id="wheelSkin" alt="skin de la roue" src="assets/wheel_sun.png" />
      <canvas id="wheelCanvas" aria-label="Roue de sélection"></canvas>
    </div>
    <div class="hub"><button id="spin" class="spin" aria-label="Tourner" title="Tourner"></button></div>
  </div>
</div>

<!-- Modal résultat (popup) -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div class="backdrop" id="backdrop"></div>
  <div class="sheet">
    <button class="close-x" id="closex" aria-label="Fermer">×</button>
    <h3 id="mTitle"></h3>
    <p id="mDesc"></p>
    <div class="actions">
      <a id="mGo" class="btn go" target="_blank" rel="noopener">Itinéraire</a>
      <button id="mClose" class="btn close">Fermer</button>
    </div>
  </div>
</div>

<canvas id="celest" style="position:fixed;inset:0;pointer-events:none"></canvas>

<script>
/* ========= ASSETS =========
- bg_sun.png / bg_moon.png → 816×1456 (portrait)
- wheel_sun.png / wheel_moon.png → 1024×1024, transparent (ne change pas)
================================ */

/* ===================== Données ===================== */
const SUN=[
 {id:"vieuxport",label:"VieuxPort",title:"Îlots & passerelles",desc:"Mini‑îles sauvages en Loire, spot chill & photo.",maps:"Port de la Jonction Nevers"},
 {id:"goguin",label:"Remparts",title:"Remparts + Tour Goguin",desc:"Balade douce jusqu’au coucher de soleil.",maps:"Quai des Mariniers Nevers"},
 {id:"bec",label:"BecAllier",title:"Belvédère du Bec d’Allier",desc:"Confluent, oiseaux, grand air.",maps:"Bec d'Allier panorama"},
 {id:"faience",label:"Faïence",title:"Atelier express faïence",desc:"Customise une petite pièce (atelier centre).",maps:"Place Carnot Nevers"},
 {id:"textures",label:"Textures",title:"Safari textures",desc:"Photo‑macro portes/fer forgé/faïences.",maps:"Rue François Mitterrand Nevers"},
 {id:"kiosque",label:"Kiosque",title:"Sieste musicale",desc:"Parc Salengro, herbe fraîche + bouquin.",maps:"Parc Roger-Salengro Nevers"},
 {id:"panorama",label:"Panorama",title:"Quai haut — Loire 360°",desc:"Vue large (golden hour).",maps:"Pont de Loire Nevers"},
 {id:"faience2",label:"Boutiques",title:"Vieilles boutiques faïence",desc:"Enseignes historiques et vitrines.",maps:"Rue du 14 Juillet Nevers"},
 {id:"toits",label:"Belvédères",title:"Points hauts photo",desc:"Belvédères/escaliers → toits + Loire.",maps:"Promenade des Remparts Nevers"},
 {id:"vitreaux",label:"Vitraux",title:"Vitraux contemporains",desc:"Art verrier moderne de la cathédrale.",maps:"Cathédrale de Nevers"},
 {id:"polaroid",label:"Polaroid",title:"Polaroid challenge",desc:"3 spots, 3 clichés.",maps:"Place Carnot Nevers"},
 {id:"marche",label:"Marché",title:"Marché & dégustation",desc:"Produits locaux en fin de matinée.",maps:"Halles de Nevers"}
];
const MOON=[
 {id:"filbleu",label:"FilBleu",title:"Fil Bleu nocturne",desc:"Parcours urbain balisé + QR, monuments by night.",maps:"Palais ducal de Nevers"},
 {id:"bernadette",label:"Bernadette",title:"Crypte & châsse",desc:"Lieu mystique au frais.",maps:"Espace Bernadette Nevers"},
 {id:"street",label:"StreetArt",title:"Street‑art discret",desc:"Pochoirs/collages à débusquer.",maps:"Place Carnot Nevers"},
 {id:"cave",label:"Cave",title:"Cave/bistrot de poche",desc:"Verre intimiste en hyper‑centre.",maps:"bar à vin centre Nevers"},
 {id:"cinema",label:"Cinéma",title:"Séance Art & Essai",desc:"Film indé en VO si possible.",maps:"Cinéma à Nevers"},
 {id:"bleu2",label:"Bleu+QR",title:"Fil Bleu — secrets",desc:"Version détails cachés.",maps:"Palais ducal de Nevers"},
 {id:"horloges",label:"Cadrans",title:"Chasse aux cadrans",desc:"Horloges, enseignes, typos d’époque.",maps:"Centre historique Nevers"},
 {id:"glyphe",label:"Glyphe",title:"Glyphe mystère",desc:"Symbole gravé à retrouver.",maps:"Rue Saint-Martin Nevers"},
 {id:"etoiles",label:"Étoiles",title:"Observatoire spontané",desc:"Regarder le ciel clair en bord de Loire.",maps:"Quai des Mariniers Nevers"},
 {id:"fresque",label:"Fresque",title:"Fresque XXL cachée",desc:"Grande peinture murale.",maps:"Rue du 14 Juillet Nevers"},
 {id:"nocturne",label:"Nocturne",title:"Remparts de nuit",desc:"Ambiance pierres chaudes + reflets Loire.",maps:"Promenade des Remparts Nevers"},
 {id:"belved",label:"Belvédère",title:"Point haut nocturne",desc:"Vues sur toits/by night.",maps:"Escaliers des remparts Nevers"}
];

/* ===================== État & refs ===================== */
const MAX_SEG=12; let mode='sun'; let pool=[...SUN]; let currentSet=shuffle(pool).slice(0,MAX_SEG);
const wheelWrap=document.getElementById('wheelWrap');
const wheel=document.getElementById('wheelCanvas');
const skin=document.getElementById('wheelSkin');
const ctx=wheel.getContext('2d');
const spinBtn=document.getElementById('spin');
const tabSun=document.getElementById('tabSun'); const tabMoon=document.getElementById('tabMoon');
const modal=document.getElementById('modal'); const mTitle=document.getElementById('mTitle'); const mDesc=document.getElementById('mDesc'); const mGo=document.getElementById('mGo'); const mClose=document.getElementById('mClose'); const closex=document.getElementById('closex'); const backdrop=document.getElementById('backdrop');
const cel=document.getElementById('celest'); const c2=cel.getContext('2d');
let baseDeg=0, spinning=false;

function shuffle(a){a=[...a]; for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a}

/* ===================== Canvas sizing DPI-proof ===================== */
function sizeCanvas(){
  const rect=wheel.getBoundingClientRect(); const w=Math.max(1,rect.width), h=Math.max(1,rect.height);
  const dpr=Math.max(1,Math.round((window.devicePixelRatio||1)*100)/100); // arrondi, évite DPR fractionnaire
  wheel.width=Math.round(w*dpr); wheel.height=Math.round(h*dpr);
  wheel.style.width=w+'px'; wheel.style.height=h+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0); // 1 unité = 1px CSS
}

/* ===================== Dessin de la roue (segments + labels dans le même canvas) ===================== */
function drawWheel(){
  sizeCanvas();
  const rect=wheel.getBoundingClientRect(); const w=rect.width, h=rect.height; const r=Math.min(w,h)/2, cx=w/2, cy=h/2;
  ctx.clearRect(0,0,w,h); ctx.save(); ctx.translate(cx,cy);
  // Bord épais
  ctx.beginPath(); ctx.arc(0,0,r-8,0,Math.PI*2); ctx.strokeStyle='rgba(0,0,0,.55)'; ctx.lineWidth=18; ctx.stroke();
  // Palettes
  const palSun=['#FFE6B3','#FFD3A3','#FFC6C6','#F7B8D9','#E6C7FF','#CFE2FF','#CFF4F3','#E1F7E9'];
  const palMoon=['#B3D9FF','#C0E7FF','#C9F1FF','#CFEAF6','#E1E0FF','#D9C8FF','#F0D6FF','#FFD9F0'];
  const pal=(mode==='sun')?palSun:palMoon; const n=currentSet.length, seg=2*Math.PI/n;
  // Clip dans le disque
  ctx.save(); ctx.beginPath(); ctx.arc(0,0,r-2,0,Math.PI*2); ctx.clip();
  for(let i=0;i<n;i++){
    const start=i*seg, end=start+seg, mid=(start+end)/2, col=pal[i%pal.length];
    const g=ctx.createLinearGradient(0,0, Math.cos(mid)*r, Math.sin(mid)*r); g.addColorStop(0,col); g.addColorStop(1,darken(col,10));
    // Segment
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r-22,start,end); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,r-22,end,end); ctx.stroke();
    // Label (tangent) — même canvas, donc il tourne avec la roue (plus de désynchro)
    const lx=Math.cos(mid)*(r*0.60), ly=Math.sin(mid)*(r*0.60);
    ctx.save(); ctx.translate(lx,ly); ctx.rotate(mid);
    ctx.font='16px ui-sans-serif,system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.lineWidth=4; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.strokeText(currentSet[i].label,0,0);
    ctx.fillStyle=darken(col,55); ctx.fillText(currentSet[i].label,0,0);
    ctx.restore();
  }
  ctx.restore(); // fin clip
  // Inner verre
  ctx.beginPath(); ctx.arc(0,0,r*0.42,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fill();
  ctx.restore();
}

function darken(hex,amt){ const n=parseInt(hex.slice(1),16); let r=(n>>16)-amt,g=((n>>8)&255)-amt,b=(n&255)-amt; r=Math.max(0,r); g=Math.max(0,g); b=Math.max(0,b); return '#'+(r<<16|g<<8|b).toString(16).padStart(6,'0').toUpperCase(); }

/* ===================== Spin ===================== */
spinBtn.addEventListener('click', spin);
function spin(){ if(spinning) return; const n=currentSet.length; if(!n) return; spinning=true; hideModal(); const slice=360/n; const idx=(Math.random()*n)|0; const sliceCenter=idx*slice+slice/2; const turns=5; const targetDeg=baseDeg+turns*360+(360-sliceCenter)+(Math.random()*2-1); wheelWrap.style.transform=`translateZ(0) rotate(${targetDeg}deg)`; wheelWrap.addEventListener('transitionend', ()=>{ baseDeg=targetDeg%360; showModal(currentSet[idx]); burst(); spinning=false; }, {once:true}); }

/* ===================== Tabs ===================== */
document.getElementById('tabSun').addEventListener('click', ()=> setMode('sun'));
document.getElementById('tabMoon').addEventListener('click', ()=> setMode('moon'));
function setMode(m){ if(mode===m) return; mode=m; document.body.dataset.mode=m; document.getElementById('tabSun').setAttribute('aria-pressed', m==='sun'); document.getElementById('tabMoon').setAttribute('aria-pressed', m==='moon'); pool=m==='sun'?[...SUN]:[...MOON]; currentSet=shuffle(pool).slice(0,MAX_SEG); wheelWrap.style.transition='none'; wheelWrap.style.transform='rotate(0deg)'; baseDeg=0; requestAnimationFrame(()=>{ wheelWrap.offsetHeight; wheelWrap.style.transition='transform 3.2s cubic-bezier(.12,.6,0,1)'; drawWheel(); }); skin.src=m==='sun'?'assets/wheel_sun.png':'assets/wheel_moon.png'; }

/* ===================== Modal ===================== */
function showModal(a){ mTitle.textContent=a.title; mDesc.textContent=a.desc; mGo.href=`https://www.google.com/maps?q=${encodeURIComponent(a.maps)}`; modal.classList.add('show'); document.body.style.overflow='hidden'; }
function hideModal(){ modal.classList.remove('show'); document.body.style.overflow=''; }
[backdrop,mClose,closex].forEach(el=> el.addEventListener('click', hideModal));

/* ===================== Particules thème Soleil/Lune ===================== */
function burst(){ const dpr=devicePixelRatio||1, W=cel.width=innerWidth*dpr, H=cel.height=innerHeight*dpr, cx=W/2, cy=H/3, N=44, isSun=(mode==='sun'); const parts=[]; for(let i=0;i<N;i++){ parts.push({x:cx,y:cy,vx:(Math.random()-.5)*0.9*dpr,vy:(Math.random()*.7+.35)*dpr,r:(isSun?6:5)*dpr,life:50+Math.random()*30,col1:isSun?'#fff3d6':'#eae9ff',col2:isSun?'#ffd36b':'#8b7cff'});} let f=0; (function step(){ c2.clearRect(0,0,W,H); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy*=1.02; p.life--; c2.save(); c2.translate(p.x,p.y); const g=c2.createRadialGradient(0,0,0,0,0,p.r); g.addColorStop(0,p.col1); g.addColorStop(.35,p.col2); g.addColorStop(1,'rgba(255,255,255,0)'); c2.fillStyle=g; c2.beginPath(); c2.arc(0,0,p.r,0,Math.PI*2); c2.fill(); c2.restore(); }); if((f+=1)<60) requestAnimationFrame(step); else c2.clearRect(0,0,W,H); })(); }

/* ===================== Init ===================== */
addEventListener('resize', drawWheel, {passive:true});
addEventListener('orientationchange', ()=> setTimeout(drawWheel,120));
drawWheel();
</script>
</body>
</html>
