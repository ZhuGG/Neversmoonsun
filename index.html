<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Roue Soleil/Lune — Nevers (layers + modal + style)</title>
<style>
:root{
  --ink:#f6f8ff; --muted:#b9c6dd; --stroke:rgba(255,255,255,.16);
  --glass:rgba(255,255,255,.10); --glass2:rgba(255,255,255,.05);
  --bg1:#0a0f1d; --bg2:#0b1429; --violet:#8b7cff; --violetDeep:#6b5bff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2) 55%,var(--bg1));-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* Backdrops (remplacés par tes PNG) */
body::before{content:"";position:fixed;inset:0;z-index:-3;opacity:.96;pointer-events:none;background-image:url("assets/bg_sun.png");background-size:cover;background-position:center;transition:opacity .6s ease}
body[data-mode="moon"]::before{background-image:url("assets/bg_moon.png")}

/* Rays doux */
body::after{content:"";position:fixed;inset:-10% -10% auto -10%;height:70%;z-index:-2;pointer-events:none;opacity:.28;filter:blur(10px);background:conic-gradient(from 0deg, rgba(255,211,107,.18) 0 20%, rgba(247,184,217,.16) 20% 38%, rgba(198,226,255,.16) 38% 70%, rgba(207,244,243,.16) 70% 100%);mask:radial-gradient(closest-side at 50% 30%,#000 40%,transparent 70%);animation:rays 40s linear infinite}
@keyframes rays{to{transform:rotate(360deg)}}

.app{min-height:100dvh;padding:16px;display:flex;flex-direction:column;gap:12px;padding-bottom:22dvh}
.header{display:flex;align-items:center;gap:10px;justify-content:space-between}
.title{padding:8px 12px;border-radius:999px;backdrop-filter: blur(12px);background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06));border:1px solid var(--stroke);font-weight:900;letter-spacing:.2px}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);font-weight:800;cursor:pointer;user-select:none}
.tab[aria-pressed="true"]{background:linear-gradient(145deg,#fff6d6,#ffe3a7 45%,#cfe6ff);color:#0b0f1f}

/* STAGE */
.stage{position:relative;width:min(92vw,560px);margin:4px auto 0;aspect-ratio:1/1}
.ringGlow{position:absolute;inset:-12px;border-radius:999px;z-index:0;filter: blur(22px) saturate(130%);opacity:.55;transition:filter .3s ease}
.aura{position:absolute;inset:-4%;border-radius:999px;z-index:0;pointer-events:none;opacity:0}
.stage.spinning .aura{opacity:.9;animation:auraPulse 1200ms cubic-bezier(.2,.7,0,1) forwards}
@keyframes auraPulse{0%{box-shadow:0 0 0 0 rgba(255,230,180,.35),0 0 0 0 rgba(160,200,255,.28)}100%{box-shadow:0 0 60px 30px rgba(255,230,180,.0),0 0 60px 30px rgba(160,200,255,.0)}}

/* VIOLET pointer visible */
.pointer{position:absolute;top:-3px;left:50%;translate:-50% 0;z-index:6;width:40px;height:40px;background: radial-gradient(circle at 60% 40%, var(--violet), var(--violetDeep));-webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M22 0 C34 10 34 34 22 44 C10 34 10 10 22 0Z"/></svg>') center/contain no-repeat;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><path d="M22 0 C34 10 34 34 22 44 C10 34 10 10 22 0Z"/></svg>') center/contain no-repeat;filter: drop-shadow(0 8px 16px rgba(0,0,0,.6))}

/* Wheel : on rotate le WRAP (canvas segments + skin + labels) */
#wheelWrap{position:relative;width:100%;height:100%;will-change:transform;transition: transform 3.1s cubic-bezier(.12,.6,0,1)}
#wheelCanvas{position:absolute;inset:0;width:100%;height:100%;border-radius:50%;background:transparent;z-index:1}
#wheelSkin{position:absolute;inset:0;width:100%;height:100%;border-radius:50%;object-fit:contain;user-select:none;pointer-events:none;filter:drop-shadow(0 24px 48px rgba(0,0,0,.45));z-index:2}
/* Nouveau calque au-dessus du skin pour que les libellés/dom restent visibles même si le PNG est opaque */
#wheelLabels{position:absolute;inset:0;z-index:3;pointer-events:none}

/* Hub bouton — disque + icône SVG */
.hub{position:absolute;top:50%;left:50%;translate:-50% -50%;width:31%;aspect-ratio:1/1;border-radius:999px;background: radial-gradient(150% 150% at 30% 20%, rgba(255,255,255,.55), rgba(255,255,255,.08) 40%, transparent 65%), conic-gradient(from 0deg, #fff0c2 0 35%, #ffd08a 35% 50%, #b7caff 50% 82%, #aee0ff 82% 100%);border:1px solid rgba(255,255,255,.35);box-shadow: inset 0 1px 8px rgba(255,255,255,.6), 0 10px 30px rgba(0,0,0,.45);display:grid;place-items:center;z-index:4}
.spin{appearance:none;border:none;cursor:pointer;border-radius:999px;width:68%;aspect-ratio:1/1;display:grid;place-items:center;background: radial-gradient(circle at 50% 35%, #ffffff, #f7f7ff 60%, #dfe7ff);box-shadow: 0 12px 22px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.8);transition: transform .18s ease}
.spin:active{transform:scale(.97)}
.spin svg{width:44%;height:44%;}

/* RESULT MODAL */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center}
.modal.show{display:flex}
.backdrop{position:absolute;inset:0;background:rgba(6,10,20,.45);backdrop-filter: blur(4px);}
.sheet{position:relative;width:min(720px,92vw);margin:0 auto 12px;border-radius:20px;padding:16px;background:linear-gradient(160deg,var(--glass),var(--glass2));border:1px solid var(--stroke);box-shadow:0 18px 40px rgba(0,0,0,.45)}
.sheet h3{margin:0 0 6px;font-size:18px}
.sheet p{margin:0 0 10px;color:var(--muted)}
.sheet .actions{display:flex;gap:8px}
.sheet .btn{flex:1;padding:12px;border-radius:12px;text-align:center;font-weight:900;color:#0b0f1f;text-decoration:none;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.6)}
.sheet .go{background: linear-gradient(145deg,#cfe6ff,#9bc9ff)}
.sheet .close{background: linear-gradient(145deg,#ffe3a7,#ffbd7c)}
.close-x{position:absolute;top:10px;right:10px;border:0;background:transparent;color:#fff;font-size:22px;opacity:.8;cursor:pointer}

@media (prefers-reduced-motion: reduce){ #wheelWrap{transition:none!important} .spin{transition:none!important} body::after{animation:none!important} }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="title">Roue des activités — Nevers · Soleil/Lune</div>
    <div class="tabs" role="group" aria-label="Choix du set">
      <button id="tabSun" class="tab" aria-pressed="true">Soleil</button>
      <button id="tabMoon" class="tab" aria-pressed="false">Lune</button>
    </div>
  </div>

  <div class="stage" id="stage">
    <div id="ringGlow" class="ringGlow" aria-hidden="true"></div>
    <div class="aura" aria-hidden="true"></div>
    <div class="pointer" aria-hidden="true"></div>
    <div id="wheelWrap">
      <canvas id="wheelCanvas" aria-label="Roue de sélection"></canvas>
      <img id="wheelSkin" alt="skin de la roue" src="assets/wheel_sun.png" />
      <canvas id="wheelLabels"></canvas>
    </div>
    <div class="hub"><button id="spin" class="spin" aria-label="Tourner" title="Tourner">
      <!-- arrows svg -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#0b0f1f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12a9 9 0 1 1-9-9"/>
        <path d="M21 3v7h-7"/>
      </svg>
    </button></div>
  </div>
</div>

<!-- Modal résultat (popup) -->
<div id="modal" class="modal" aria-modal="true" role="dialog" hidden>
  <div class="backdrop" id="backdrop"></div>
  <div class="sheet">
    <button class="close-x" id="closex" aria-label="Fermer">×</button>
    <h3 id="mTitle"></h3>
    <p id="mDesc"></p>
    <div class="actions">
      <a id="mGo" class="btn go">Itinéraire</a>
      <button id="mClose" class="btn close">Fermer</button>
    </div>
  </div>
</div>

<!-- Particules célestes -->
<canvas id="celest" style="position:fixed;inset:0;pointer-events:none"></canvas>

<script>
/* ========= ASSETS =========
- bg_sun.png / bg_moon.png     → 1440×3120
- wheel_sun.png / wheel_moon.png → 1024×1024, transparent
============================ */

/* ===================== Données (sets) ===================== */
const SUN = [
  {id:"vieuxport",label:"VieuxPort",title:"Îlots & passerelles",desc:"Mini‑îles sauvages en Loire, spot chill & photo.",maps:"Port de la Jonction Nevers"},
  {id:"goguin",label:"Remparts",title:"Remparts + Tour Goguin",desc:"Balade douce jusqu’au coucher de soleil.",maps:"Quai des Mariniers Nevers"},
  {id:"bec",label:"BecAllier",title:"Belvédère du Bec d’Allier",desc:"Confluent, oiseaux, grand air.",maps:"Bec d'Allier panorama"},
  {id:"faience",label:"Faïence",title:"Atelier express faïence",desc:"Customise une petite pièce (atelier centre).",maps:"Place Carnot Nevers"},
  {id:"textures",label:"Textures",title:"Safari textures",desc:"Photo‑macro portes/fer forgé/faïences.",maps:"Rue François Mitterrand Nevers"},
  {id:"kiosque",label:"Kiosque",title:"Sieste musicale",desc:"Parc Salengro, herbe fraîche + bouquin.",maps:"Parc Roger-Salengro Nevers"},
  {id:"panorama",label:"Panorama",title:"Quai haut — Loire 360°",desc:"Vue large (golden hour).",maps:"Pont de Loire Nevers"},
  {id:"faience2",label:"Boutiques",title:"Vieilles boutiques faïence",desc:"Enseignes historiques et vitrines.",maps:"Rue du 14 Juillet Nevers"},
  {id:"toits",label:"Belvédères",title:"Points hauts photo",desc:"Belvédères/escaliers → toits + Loire.",maps:"Promenade des Remparts Nevers"},
  {id:"vitreaux",label:"Vitraux",title:"Vitraux contemporains",desc:"Art verrier moderne de la cathédrale.",maps:"Cathédrale de Nevers"},
  {id:"polaroid",label:"Polaroid",title:"Polaroid challenge",desc:"3 spots, 3 clichés.",maps:"Place Carnot Nevers"},
  {id:"marche",label:"Marché",title:"Marché & dégustation",desc:"Produits locaux en fin de matinée.",maps:"Halles de Nevers"}
];
const MOON = [
  {id:"filbleu",label:"FilBleu",title:"Fil Bleu nocturne",desc:"Parcours urbain balisé + QR, monuments by night.",maps:"Palais ducal de Nevers"},
  {id:"bernadette",label:"Bernadette",title:"Crypte & châsse",desc:"Lieu mystique au frais.",maps:"Espace Bernadette Nevers"},
  {id:"street",label:"StreetArt",title:"Street‑art discret",desc:"Pochoirs/collages à débusquer.",maps:"Place Carnot Nevers"},
  {id:"cave",label:"Cave",title:"Cave/bistrot de poche",desc:"Verre intimiste en hyper‑centre.",maps:"bar à vin centre Nevers"},
  {id:"cinema",label:"Cinéma",title:"Séance Art & Essai",desc:"Film indé en VO si possible.",maps:"Cinéma à Nevers"},
  {id:"bleu2",label:"Bleu+QR",title:"Fil Bleu — secrets",desc:"Version détails cachés.",maps:"Palais ducal de Nevers"},
  {id:"horloges",label:"Cadrans",title:"Chasse aux cadrans",desc:"Horloges, enseignes, typos d’époque.",maps:"Centre historique Nevers"},
  {id:"glyphe",label:"Glyphe",title:"Glyphe mystère",desc:"Symbole gravé à retrouver.",maps:"Rue Saint-Martin Nevers"},
  {id:"etoiles",label:"Étoiles",title:"Observatoire spontané",desc:"Regarder le ciel clair en bord de Loire.",maps:"Quai des Mariniers Nevers"},
  {id:"fresque",label:"Fresque",title:"Fresque XXL cachée",desc:"Grande peinture murale.",maps:"Rue du 14 Juillet Nevers"},
  {id:"nocturne",label:"Nocturne",title:"Remparts de nuit",desc:"Ambiance pierres chaudes + reflets Loire.",maps:"Promenade des Remparts Nevers"},
  {id:"belved",label:"Belvédère",title:"Point haut nocturne",desc:"Vues sur toits/by night.",maps:"Escaliers des remparts Nevers"}
];

/* ===================== État & elements ===================== */
const MAX_SEG = 12; let mode='sun'; let pool=[...SUN]; let currentSet=sampleSet(pool);
const app=document.getElementById('app'); app.dataset.mode='sun';
const stage=document.getElementById('stage');
const wheelWrap=document.getElementById('wheelWrap');
const wheel=document.getElementById('wheelCanvas');
const labelsCvs=document.getElementById('wheelLabels');
const skin=document.getElementById('wheelSkin');
const ctx=wheel.getContext('2d');
const lctx=labelsCvs.getContext('2d');
const spinBtn=document.getElementById('spin');
const tabSun=document.getElementById('tabSun'); const tabMoon=document.getElementById('tabMoon'); const ringGlow=document.getElementById('ringGlow');
const modal=document.getElementById('modal'); const mTitle=document.getElementById('mTitle'); const mDesc=document.getElementById('mDesc'); const mGo=document.getElementById('mGo'); const mClose=document.getElementById('mClose'); const closex=document.getElementById('closex'); const backdrop=document.getElementById('backdrop');
const cel=document.getElementById('celest'); const c2=cel.getContext('2d');

let size, baseDeg=0, spinning=false, sunImg=null, moonImg=null;

function sampleSet(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a.slice(0, Math.min(MAX_SEG, a.length)); }
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function ensureSkins(){ if(!sunImg) sunImg=await loadImage('assets/wheel_sun.png'); if(!moonImg) moonImg=await loadImage('assets/wheel_moon.png'); }

/* ===================== Rendu roue ===================== */
function drawWheel(){
  const w=wheel.clientWidth, dpr=devicePixelRatio||1; wheel.width=w*dpr; wheel.height=w*dpr; labelsCvs.width=w*dpr; labelsCvs.height=w*dpr; size=wheel.width; const r=size/2, cx=r, cy=r; ctx.clearRect(0,0,size,size); lctx.clearRect(0,0,size,size); ctx.save(); ctx.translate(cx,cy); lctx.save(); lctx.translate(cx,cy);
  const paletteSun=['#FFE6B3','#FFD3A3','#FFC6C6','#F7B8D9','#E6C7FF','#CFE2FF','#CFF4F3','#E1F7E9'];
  const paletteMoon=['#B3D9FF','#C0E7FF','#C9F1FF','#CFEAF6','#E1E0FF','#D9C8FF','#F0D6FF','#FFD9F0'];
  const palette=(mode==='sun')?paletteSun:paletteMoon;
  const n=currentSet.length, seg=2*Math.PI/n;
  for(let i=0;i<n;i++){
    const start=i*seg, end=start+seg, mid=(start+end)/2, col=palette[i%palette.length];
    const g=ctx.createLinearGradient(0,0, Math.cos(mid)*r, Math.sin(mid)*r); g.addColorStop(0,col); g.addColorStop(1,shade(col,-10));
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r-22,start,end); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.45)'; ctx.lineWidth=2*dpr; ctx.beginPath(); ctx.arc(0,0,r-22,end,end); ctx.stroke();
    // labels sur canvas supérieur (au-dessus du skin)
    const lx=Math.cos(mid)*(r*0.62), ly=Math.sin(mid)*(r*0.62); lctx.save(); lctx.translate(lx,ly); lctx.rotate(mid); lctx.fillStyle='#0c1326'; lctx.font=`${14*dpr}px ui-sans-serif,system-ui`; lctx.textAlign='center'; lctx.textBaseline='middle'; lctx.fillText(currentSet[i].label,0,0); lctx.restore();
  }
  ctx.beginPath(); ctx.arc(0,0,r*0.42,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fill();
  ctx.restore(); lctx.restore();
}
function shade(hex,amt){ const col=hex.replace('#',''); const num=parseInt(col,16); let r=(num>>16)+amt,g=((num>>8)&0xFF)+amt,b=(num&0xFF)+amt; r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b)); return '#'+(r<<16|g<<8|b).toString(16).padStart(6,'0').toUpperCase(); }

/* ===================== Spin ===================== */
spinBtn.addEventListener('click', spin);
function spin(){ if(spinning) return; const n=currentSet.length; if(!n) return; spinning=true; hideModal(); const idx=(Math.random()*n)|0; const slice=360/n; const sliceCenter=idx*slice+slice/2; const turns=5; const targetDeg=baseDeg+turns*360+(360-sliceCenter)+(Math.random()*2-1); stage.classList.add('spinning'); wheelWrap.style.transform=`rotate(${targetDeg}deg)`; const onEnd=()=>{ wheelWrap.removeEventListener('transitionend', onEnd); baseDeg=targetDeg%360; showModal(currentSet[idx]); burst(); stage.classList.remove('spinning'); spinning=false; }; wheelWrap.addEventListener('transitionend', onEnd); }

/* ===================== Tabs ===================== */
async function setMode(m){ if(mode===m) return; mode=m; document.body.dataset.mode=m; tabSun.setAttribute('aria-pressed', m==='sun'); tabMoon.setAttribute('aria-pressed', m==='moon'); pool=m==='sun'?[...SUN]:[...MOON]; currentSet=sampleSet(pool); wheelWrap.style.transition='none'; wheelWrap.style.transform='rotate(0deg)'; baseDeg=0; await ensureSkins(); skin.src=m==='sun'?'assets/wheel_sun.png':'assets/wheel_moon.png'; requestAnimationFrame(()=>{ wheelWrap.offsetHeight; wheelWrap.style.transition='transform 3.1s cubic-bezier(.12,.6,0,1)'; drawWheel(); }); ringGlow.style.background = m==='sun' ? 'conic-gradient(from 0deg, rgba(255,211,107,.28) 0 20%, rgba(247,184,217,.26) 20% 40%, rgba(198,226,255,.24) 40% 70%, rgba(207,244,243,.22) 70% 100%)' : 'conic-gradient(from 0deg, rgba(179,217,255,.28) 0 25%, rgba(201,241,255,.26) 25% 55%, rgba(225,224,255,.22) 55% 80%, rgba(255,217,240,.22) 80% 100%)'; }

document.getElementById('tabSun').addEventListener('click', ()=> setMode('sun'));
document.getElementById('tabMoon').addEventListener('click', ()=> setMode('moon'));

/* ===================== Modal ===================== */
function showModal(a){ mTitle.textContent=a.title; mDesc.textContent=a.desc; mGo.href=`https://www.google.com/maps?q=${encodeURIComponent(a.maps)}`; modal.hidden=false; modal.classList.add('show'); }
function hideModal(){ modal.classList.remove('show'); modal.hidden=true; }
[backdrop,mClose,closex].forEach(el=> el.addEventListener('click', hideModal));

/* ===================== Particules ===================== */
function burst(){ const W=cel.width=innerWidth*(devicePixelRatio||1), H=cel.height=innerHeight*(devicePixelRatio||1), cx=W/2, cy=H/3, N=46, parts=[], isSun=(mode==='sun'); for(let i=0;i<N;i++){ parts.push({x:cx,y:cy,vx:(Math.random()-.5)*0.9*(devicePixelRatio||1),vy:(Math.random()*.7+.35)*(devicePixelRatio||1),r:(isSun?6:5)*(devicePixelRatio||1),life:50+Math.random()*30,col1:isSun?'#fff3d6':'#eae9ff',col2:isSun?'#ffd36b':'#8b7cff'}); } let f=0;(function step(){ c2.clearRect(0,0,W,H); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy*=1.02; p.life--; c2.save(); c2.translate(p.x,p.y); const g=c2.createRadialGradient(0,0,0,0,0,p.r); g.addColorStop(0,p.col1); g.addColorStop(.35,p.col2); g.addColorStop(1,'rgba(255,255,255,0)'); c2.fillStyle=g; c2.beginPath(); c2.arc(0,0,p.r,0,Math.PI*2); c2.fill(); c2.restore(); }); if((f+=1)<60) requestAnimationFrame(step); else c2.clearRect(0,0,W,H); })(); }

/* ===================== Init ===================== */
(async function init(){ await ensureSkins(); drawWheel(); })();
addEventListener('resize', ()=> drawWheel(), {passive:true});
</script>
</body>
</html>
